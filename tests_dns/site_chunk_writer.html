<!DOCTYPE html>
<html>
<head>
    <title>Chunk Writer via POST</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .chunk-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .success { color: green; }
        .error { color: red; }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Écriture de chunks via POST</h1>
    
    <div class="container">
        <h3>Configuration</h3>
        <label>Texte à envoyer: <input type="text" id="inputText" value="Je suis ton pere. blablabla" size="50"></label><br>
        <label>Taille du chunk: <input type="number" id="chunkSize" value="20" min="1" max="100"></label><br>
        <button onclick="startChunkWriting()">Commencer l'envoi</button>
        <button onclick="clearFile()">Effacer le fichier</button>
        <button onclick="readFile()">Lire le fichier</button>
    </div>

    <div class="container">
        <h3>Progression</h3>
        <div id="progress"></div>
        <div id="chunks"></div>
    </div>

    <div class="container">
        <h3>Contenu du fichier</h3>
        <div id="output">Aucun contenu</div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:5001';
        
        async function writeChunk(chunk, index) {
            try {
                const response = await fetch(`${SERVER_URL}/write_chunk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chunk: chunk,
                        index: index
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    return { success: true, message: result.message };
                } else {
                    return { success: false, error: result.error };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function startChunkWriting() {
            const inputText = document.getElementById('inputText').value;
            const chunkSize = parseInt(document.getElementById('chunkSize').value);
            
            if (!inputText) {
                alert('Veuillez entrer du texte à envoyer');
                return;
            }

            // Convertir en base64
            const data = btoa(inputText);
            const chunks = data.match(new RegExp(`.{1,${chunkSize}}`, 'g')) || [];
            
            document.getElementById('progress').innerHTML = `<p>Envoi de ${chunks.length} chunks...</p>`;
            document.getElementById('chunks').innerHTML = '';

            for (let i = 0; i < chunks.length; i++) {
                const chunk = chunks[i];
                
                // Afficher le chunk
                const chunkDiv = document.createElement('div');
                chunkDiv.className = 'chunk-item';
                chunkDiv.innerHTML = `Chunk ${i + 1}: ${chunk}`;
                document.getElementById('chunks').appendChild(chunkDiv);

                // Envoyer le chunk via POST
                const result = await writeChunk(chunk, i);
                
                if (result.success) {
                    chunkDiv.innerHTML += ` <span class="success">✓ Envoyé</span>`;
                } else {
                    chunkDiv.innerHTML += ` <span class="error">✗ Erreur: ${result.error}</span>`;
                    break;
                }

                // Petit délai pour visualiser le processus
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            document.getElementById('progress').innerHTML = '<p class="success">✓ Tous les chunks ont été envoyés!</p>';
            
            // Lire le fichier final
            setTimeout(readFile, 1000);
        }

        async function clearFile() {
            try {
                const response = await fetch(`${SERVER_URL}/clear_file`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('output').textContent = 'Fichier effacé';
                    document.getElementById('chunks').innerHTML = '';
                    document.getElementById('progress').innerHTML = '';
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function readFile() {
            try {
                const response = await fetch(`${SERVER_URL}/get_file`);
                const result = await response.json();
                
                if (result.content) {
                    // Décoder le contenu base64
                    try {
                        const decoded = atob(result.content);
                        document.getElementById('output').textContent = decoded;
                    } catch (e) {
                        document.getElementById('output').textContent = result.content;
                    }
                } else {
                    document.getElementById('output').textContent = 'Fichier vide';
                }
            } catch (error) {
                document.getElementById('output').textContent = `Erreur: ${error.message}`;
            }
        }

        // Fonction alternative avec XMLHttpRequest pour compatibilité
        function writeChunkXHR(chunk, index) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${SERVER_URL}/write_chunk`, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                    }
                };
                
                xhr.onerror = function() {
                    reject(new Error('Erreur réseau'));
                };
                
                xhr.send(JSON.stringify({chunk: chunk, index: index}));
            });
        }
    </script>
</body>
</html>
